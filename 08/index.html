<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>CWP08</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="../css/reveal.css">
    <link rel="stylesheet" href="../css/theme/yandex.css" id="theme">
    <link rel="stylesheet" href="../lib/css/zenburn.css">
    <link rel="stylesheet" href="../css/user.css">
</head>
<body class="yandex nodejs"><div class="reveal"><div class="slides">

    <section class="large">
        <h2>Программируем на Express.js</h2>
        <p class="author">
            <small>Лекция 08</small>
        </p>
    </section>

    <section>
        <h4>Architecture</h4>

        <img src="images/architecture.png">
    </section>

    <section>
        <h4>Project structure</h4>

        <img src="images/project.png">
    </section>

    <section>
        <h4>package.json</h4>

        <pre class="javascript"><code>
{
  "name": "sample",
  "version": "0.0.1",
  "dependencies": {
    "express": "^4.14.0",
    "body-parser": "^1.15.2",
    "cookie-parser": "^1.4.3",
    "mysql": "^2.11.1",
    "sequelize": "^3.24.1"
  }
}
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
const express = require('express');
const Sequelize = require('sequelize');
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');

const errors = require('./utils/errors');
const config = require('./config');
        </code></pre>
    </section>

    <section>
        <h4>config.json</h4>

        <pre class="javascript"><code>
{
  "db": {
    "host": "127.0.0.1",
    "name": "my_db",
    "user": "myuser",
    "password": "123#qwe"
  },
  "env": "dev",
  "cookie": {
    "key": "secret key",
    "auth": "__auth_id"
  }
}
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
const postService = require('./services/post')
    (dbcontext.post, errors);

const userService = require('./services/user')
    (dbcontext.user, dbcontext.role, errors);

const roleService = require('./services/role')
    (dbcontext.role, errors);

const authService = require('./services/auth')
    (dbcontext.user, dbcontext.role, errors);

const cacheService = require('./services/cache');
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
const apiController
  = require('./controllers/api')
    (postService, userService, roleService,
      authService, cacheService, config);
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
const logger = require('./utils/logger');

const auth = require('./utils/auth')
    (authService, config, errors);

const cache = require('./utils/cache')
    (cacheService);
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
const app = express();

app.use(express.static('public'));
app.use(cookieParser(config.cookie.key));
app.use(bodyParser.json());

app.use('/api', logger);
app.use('/api', auth);
app.use('/api', cache);
app.use('/api', apiController);
        </code></pre>
    </section>

    <section>
        <h4>index.js</h4>

        <pre class="javascript"><code>
dbcontext.sequelize
  .sync()
  .then(() => {
    app.listen(3000, () =>
      console.log('Running'));
  })
  .catch((err) => console.log(err));
        </code></pre>
    </section>

  <section>
    <h3><span class="red">M</span>odel</h3>
    <h4>Модель</h4>
  </section>

  <section>
    <h4>Модель</h4>

    <ul>
      <li class="left fragment">класс, структура, схема</li>
      <li class="left fragment">отражает сущность предметной области</li>
      <li class="left fragment">абстракция</li>
      <li class="left fragment">таблица в БД - модель в коде</li>
    </ul>
  </section>

    <section>
        <h4>./models/post.js</h4>

        <pre class="javascript"><code>
module.exports = (Sequelize, sequelize) => {
    return sequelize.define('posts', {
        id: {
            type: Sequelize.INTEGER,
            primaryKey: true,
            autoIncrement: true
        },

        title: { type: Sequelize.STRING },
        content: Sequelize.STRING,
        date: Sequelize.DATEONLY,
        rating: Sequelize.INTEGER,

        draft: Sequelize.BOOLEAN
};
        </code></pre>
    </section>

  <section>
    <h4>./models/user.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, sequelize) => {
    return sequelize.define('users', {
        id: {
            type: Sequelize.INTEGER,
            primaryKey: true,
            autoIncrement: true
        },

        email: Sequelize.STRING,
        password: Sequelize.STRING,

        firstname: Sequelize.STRING,
        lastname: Sequelize.STRING
    });
};
        </code></pre>
  </section>

  <section>
    <h4>./models/role.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, sequelize) => {
    return sequelize.define('roles', {
        id: {
            type: Sequelize.INTEGER,
            primaryKey: true,
            autoIncrement: true
        },

        name: Sequelize.STRING
    });
};
        </code></pre>
  </section>

  <section>
    <h4>./models/userRole.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, sequelize) => {
    return sequelize.define('userRoles', {
        id: {
            type: Sequelize.INTEGER,
            primaryKey: true,
            autoIncrement: true
        }
    });
};
        </code></pre>
  </section>

  <section>
    <h3><span class="red">C</span>ontext</h3>
    <h4>Контекст / ORM</h4>
  </section>

  <section>
    <h4>Контекст</h4>

    <ul>
      <li class="left fragment">связи между моделями</li>
      <li class="left fragment">перевод вызова методов в запросы</li>
      <li class="left fragment">маппинг ответов на объекты</li>
    </ul>
  </section>

  <section>
    <h4>./context/db.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, config) => {
  const options = {
    host: config.db.host,
    dialect: 'mysql',
    logging: false,
    define: {
      timestamps: true,
      paranoid: true,
      defaultScope: {
        where: { deletedAt: { $eq: null } }
      }
    }
  };
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./context/db.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, config) => {
  ...
  const sequelize = new Sequelize(config.db.name,
      config.db.user, config.db.password, options);

  const User = require('../models/user')
      (Sequelize, sequelize);
  const Role = require('../models/role')
      (Sequelize, sequelize);
  const UserRole = require('../models/userRole')
      (Sequelize, sequelize);
  const Post = require('../models/post')
      (Sequelize, sequelize);
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./context/db.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, config) => {
  ...
  // User <-> Role
  User.belongsToMany(Role,
      { through: UserRole });

  Role.belongsToMany(User,
      { through: UserRole });

  // Post -> User
  Post.belongsTo(User);
  User.hasMany(Post);
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./context/db.js</h4>

    <pre class="javascript"><code>
module.exports = (Sequelize, config) => {
  ...
  return {
    user: User,
    role: Role,
    post: Post,

    sequelize: sequelize
  };
};
        </code></pre>
  </section>

  <section>
    <h3><span class="red">R</span>epository</h3>
    <h4>Репозиторий</h4>
  </section>

  <section>
    <h4>Репозиторий</h4>

    <ul>
      <li class="left fragment">каждой модели - репозиторий</li>
      <li class="left fragment">CRUD</li>
    </ul>
  </section>

  <section>
    <h3><span class="red">S</span>ervice</h3>
    <h4>Сервис</h4>
  </section>

  <section>
    <h4>Сервис</h4>

    <ul>
      <li class="left fragment">потребляет 1 и более репозиториев</li>
      <li class="left fragment">валидация</li>
      <li class="left fragment">бизнес-логика</li>
      <li class="left fragment">может возвращать DTO</li>
    </ul>
  </section>

  <section>
    <h4>./services/base.js</h4>

    <pre class="javascript"><code>
function BaseService(repository, errors) {
  const defaults = {
    readChunk: { limit: 10, page: 1,
      order: 'asc', orderField: 'id' }
  };

  let self = this;

  this.readChunk = readChunk;
  this.read = read;
  this.baseCreate = baseCreate;
  this.baseUpdate = baseUpdate;
  this.delete = del;
  ...
}
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js</h4>

    <pre class="javascript"><code>
module.exports = BaseService;
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js => readChunk(options)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  options = Object.assign({},
    defaults.readChunk, options);

  let limit = options.limit;
  let offset = (options.page - 1)
    * options.limit;

  repository
    .findAll({
      limit: limit, offset: offset, raw: true
      order: [[options.orderField,
        options.order.toUpperCase()]]
    })
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js => read(id)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  id = parseInt(id);

  if (isNaN(id)) {
    reject(errors.invalidId);
    return;
  }

  repository.findById(id, { raw: true })
    .then((post) => {
        if (post == null) reject(errors.notFound);
        else resolve(post);
    }).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js => baseCreate(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  repository.create(data)
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js => baseUpdate(id, data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  repository.update(data, {
      where: { id: id },
      limit: 1
    })
    .then(() => {
      return self.read(data.id);
    })
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/base.js => del(id)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  repository.destroy({ where: { id: id } })
    .then(() => resolve({ success: true }))
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/post.js</h4>

    <pre class="javascript"><code>
module.exports = (postRepository, errors) => {
  const BaseService = require('./base');

  Object.setPrototypeOf(PostService.prototype,
    BaseService.prototype);

  function PostService(postRepository, errors) {
    BaseService.call(this,
      postRepository, errors);
    ...
  }

  return new PostService(postRepository, errors);
};
        </code></pre>
  </section>

  <section>
    <h4>./services/post.js</h4>

    <pre class="javascript"><code>
module.exports = (postRepository, errors) => {
  ...
  function PostService(postRepository, errors) {
    ...
    let self = this;

    self.create = create;
    self.update = update;
    self.upvote = upvote;
    self.downvote = downvote;
    ...
  }
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./services/post.js => create(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  let post = {
    title: data.title,
    content: data.content,
    date: data.date,
    draft: data.draft,
    userId: data.userId,
    rating: 0
  };

  self.baseCreate(post)
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/post.js => update(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  let post = {
    title: data.title,
    content: data.content,
    date: data.date,
    draft: data.draft
  };

  self.baseUpdate(data.id, post)
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/post.js => upvote(id)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  postRepository.findById(id)
    .then((post) => {
      return post.increment({ rating: 1 })
    })
    .then(() => resolve({ success: true }))
    .catch(reject);
});

        </code></pre>
  </section>

  <section>
    <h4>./services/post.js => downvote(id)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  postRepository.findById(id)
    .then((post) => {
      return post.decrement({ rating: 1 })
    })
    .then(() => resolve({ success: true }))
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/user.js</h4>

    <pre class="javascript"><code>
module.exports = (userRepository, roleRepository,
    errors) => {
  const BaseService = require('./base');

  Object.setPrototypeOf(UserService.prototype,
    BaseService.prototype);

  function UserService(userRepository,
      roleRepository, errors) {
    BaseService.call(this, userRepository, errors);
    ...
  }

  return new UserService(userRepository,
    roleRepository, errors);
};
        </code></pre>
  </section>

  <section>
    <h4>./services/user.js</h4>

    <pre class="javascript"><code>
module.exports = (userRepository, roleRepository, errors) => {
  ...
  function UserService(userRepository,
    roleRepository, errors) {
    ...
    let self = this;

    self.update = update;
    self.grant = grant;
    self.revoke = revoke;
    ...
  }
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./services/user.js => update(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  let user = {
    password: data.password,
    firstname: data.firstname,
    lastname: data.lastname
  };

  self.baseUpdate(data.id, user)
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/user.js => grant(userId, roleId)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  Promise
    .all([
      userRepository.findById(userId),
      roleRepository.findById(roleId)
    ])
    .then(([user, role]) => {
      return user.addRole(role);
    })
    .then(() => resolve({ success: true }))
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/user.js => revoke(userId, roleId)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  Promise
    .all([
      userRepository.findById(userId),
      roleRepository.findById(roleId)
    ])
    .then(([user, role]) => {
      return user.removeRole(role);
    })
    .then(() => resolve({ success: true }))
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/role.js</h4>

    <pre class="javascript"><code>
module.exports = (roleRepository, errors) => {
  const BaseService = require('./base');

  Object.setPrototypeOf(RoleService.prototype,
    BaseService.prototype);

  function RoleService(roleRepository, errors) {
    BaseService.call(this, roleRepository, errors);
    ...
  }

  return new RoleService(roleRepository, errors);
};
        </code></pre>
  </section>

  <section>
    <h4>./services/role.js</h4>

    <pre class="javascript"><code>
module.exports = (roleRepository, errors) => {
  ...
  function RoleService(roleRepository, errors) {
    ...
    let self = this;

    self.create = create;
    ...
  }
  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./services/role.js => create(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  let role = {
      name: data.name
  };

  self.baseCreate(role)
    .then(resolve).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js</h4>

    <pre class="javascript"><code>
module.exports = (userRepository, roleRepository, errors) => {
  const permissions = {
      ...
  };

  return {
    login: login,
    register: register,
    checkPermissions: checkPermissions
  };

  ...
};
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js</h4>

    <pre class="javascript"><code>
const permissions = {
  '/posts/create': 'user',
  '/posts/update': 'user',
  '/posts/delete': 'user',

  '/users': 'administrator',
  '/users/:id': 'administrator',
  '/users/update': 'administrator',
  '/users/delete': 'administrator',
  '/users/grant': 'administrator',
  '/users/revoke': 'administrator',

  '/roles': 'administrator',
  '/roles/:id': 'administrator',
  '/roles/create': 'administrator',
  '/roles/delete': 'administrator'
};
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js => login(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  userRepository
    .findOne({ where: { email: data.email },
      attributes: ['id', 'password'] })
    .then((user) => {
      if (user == null
          || user.password !== data.password) {
        reject(errors.wrongCredentials);
        return;
      }

      resolve(user.id);
    }).catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js => register(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  let user = {
    email: data.email,
    password: data.password,
    firstname: data.firstname,
    lastname: data.lastname
  };

  ...
});
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js => register(data)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  ...

  Promise.all([
      userRepository.create(user),
      roleRepository.findOne(
        { where: { name: 'user' } })
    ])
    .then(([user, role]) => {
      return user.addRole(role);
    })
    .then(() => resolve({ success: true }))
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js => checkPerms(userId, route)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  if (permissions[route] == undefined) resolve();
  else if (userId == undefined) reject();
  else {
    ...
  }
});
        </code></pre>
  </section>

  <section>
    <h4>./services/auth.js => checkPerms(userId, route)</h4>

    <pre class="javascript"><code>
return new Promise((resolve, reject) => {
  ...
  Promise.all([
      userRepository.findById(userId),
      roleRepository.findOne(
        { where: { name: permissions[route] } })
    ])
    .then(([user, role]) => {
      return user.hasRole(role);
    })
    .then((has) => {
      if (has) resolve();
      else reject();
    })
    .catch(reject);
});
        </code></pre>
  </section>

  <section>
    <h4>./services/cache.js</h4>

    <pre class="javascript"><code>
module.exports = {
    set: (req, data) => {},
    get: (req) => { return undefined; }
};
        </code></pre>
  </section>

  <section>
    <h3><span class="red">C</span>ontroller</h3>
    <h4>Контроллер</h4>
  </section>

  <section>
    <h4>Контроллер</h4>

    <ul>
      <li class="left fragment">потребляет 1 и более сервисов</li>
      <li class="left fragment">запросы от клиента</li>
      <li class="left fragment">логика приложения</li>
    </ul>
  </section>

  <section>
    <h4>./controllers/api.js</h4>

    <pre class="javascript"><code>
module.exports = (postService, userService,
    roleService, authService, cacheService,
    config) => {
  const router = express.Router();

  const postController = require('./post')
    (postService, cacheService, promiseHandler);
  const userController = require('./user')
      (userService, promiseHandler);
  const roleController = require('./role')
      (roleService, promiseHandler);
  const authController = require('./auth')
      (authService, config);
  ...
};
...
        </code></pre>
  </section>



  <section>
    <h4>./controllers/api.js</h4>

    <pre class="javascript"><code>
module.exports = (...) => {
  ...
  router.use('/posts', postController);
  router.use('/users', userController);
  router.use('/roles', roleController);
  router.use('/auth', authController);

  return router;
};
...
        </code></pre>
  </section>

  <section>
    <h4>./controllers/api.js</h4>

    <pre class="javascript"><code>
module.exports = ...;

function promiseHandler(res, promise) {
  promise
    .then((data) => res.json(data))
    .catch((err) => res.error(err));
}
        </code></pre>
  </section>

</div></div>

<script src="../lib/js/head.min.js"></script>
<script src="../js/reveal.js"></script>
<script>
    Reveal.initialize({
        controls: false,
        progress: true,
        slideNumber: true,
        history: true,
        center: true,
        hideAddressBar: true,
        transition: 'slide',
        dependencies: [
            {
                src: '../plugin/highlight/highlight.js',
                async: true,
                condition: function () {
                    return Boolean(document.querySelector('pre code'));
                },
                callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>
</body>
</html>
